# README

This directory contains docker builds for the CUAHSI Domain Subsetter
"subsetting" routines. 

Each directory contains the following files:

- `Dockerfile` - the build definition for the standalone docker image  
- `Dockerfile.argo` - the build definition for the argo docker image. This
inherits the image created by *Dockerfile* and expects input arguments in the
form of environment variables. This is necessary for CUAHSI's Argo workflow
configuration.  
- `./build.sh` - script for building the standalone docker image  
- `./build-argo.sh` - script for building the argo-specific docker image.  

## Execute Locally

Each directory contains a `test.sh` script that illustrates how the subsetting
routines can be executed locally. Note that each of these requires static input
data that must be collected by the user ahead of time.

## Execute in Argo 

The following tables outline the parameters executing the subsetting routines
in CUAHSI's Argo Workflow CI (https://workflows.cuahsi.io/).

### Parflow v.1

**Custom Workflow**

|Key| Value|
|---|---|
|container| cuahsi/parflow-subset-argo:v1|
||
|*Environment Variables* |
|PFINPUT| /srv/input/pfconus.v1.0|
|SHAPE| /srv/output/{**output-dir**}/{**watershed.shp**}|
|OUTPUT| /srv/output/{**output-dir**} |
|LABEL| {**job name**} |
||
|*Volumes*|
|endpoint| https://storage.googleapis.com|
|name| subsetter-static-input|
|mount dir| /srv/input|
|endpoint| https://storage.googleapis.com|
|name| subsetter-outputs|
|mount dir| /srv/output|

- The **watershed** shapefile must be in the following coordinate reference system:
```
GEOGCS["GCS_WGS_1984",DATUM["D_WGS_1984",SPHEROID["WGS_1984",637813 7.0,298.257223563]],PRIMEM["Greenwich",0.0],UNIT["Degree",0.0174532 925199433]]
```
- **output-dir** must be created as a GCP bucket prior to executing the workflow.
- **job name** is the output name to use when saving subset outputs.

### NWM v.1

**Custom Workflow**

|Key| Value|
|---|---|
|container| cuahsi/subset-wrfhydro-argo:v1|
||
|*Environment Variables* |
|XMIN| {**xmin in lcc**}|
|XMAX| {**xmax in lcc**}|
|YMIN| {**ymin in lcc**}|
|YMAX| {**ymax in lcc**}|
|OUTPUT| /srv/output/{**output-dir**} |
|NWMINPUT| /srv/domain/nwm.v1.2.4 |
||
|*Volumes*|
|endpoint| https://storage.googleapis.com|
|name| subsetter-static-input|
|mount dir| /srv/domain|
|endpoint| https://storage.googleapis.com|
|name| subsetter-outputs|
|mount dir| /srv/output|

- Xmin, Xmax, Ymin, Ymax must be provided in the WRF-HYDRO/NWM coordinate
  reference system. This is defined as:
  ```
  esri_pe_string = "PROJCS[\"Sphere_Lambert_Conformal_Conic\",GEOGCS[\"GCS_Sphere\",DATUM[\"D_Sphere\",SPHEROID[\"Sphere\",6370000.0,0.0]],PRIMEM[\"Greenwich\",0.0],UNIT[\"Degree\",0.0174532925199433]],PROJECTION[\"Lambert_Conformal_Conic\"],PARAMETER[\"false_easting\",0.0],PARAMETER[\"false_northing\",0.0],PARAMETER[\"central_meridian\",-97.0],PARAMETER[\"standard_parallel_1\",30.0],PARAMETER[\"standard_parallel_2\",60.0],PARAMETER[\"latitude_of_origin\",40.0000076294],UNIT[\"Meter\",1.0]];-35691800 -29075200 126180232.640845;-100000 10000;-100000 10000;0.001;0.001;0.001;IsHighPrecision" ;
  ```
- output-dir must be created as a GCP bucket prior to executing the workflow.

## Data Storage

Input Data: `gs://subsetter-static-input`
    - These are the static model input datasets that are used as  
      inputs to the subsetting process.  

Output Data: `gs://subsetter-outputs`
    - These are the output subsets that are generated by the domain subsetter,  
      i.e. user output files.  

## Service Account

- domain-subsetter@thredds.iam.gserviceaccount.com  
  - View permission to Input Data bucket  
  - Create permission on Output Data bucket  
